<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>LowLevelCode - JS Encryption library</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">JS Encryption library</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Home</a>
                    </li>
                    <li >
                        <a href="../ApplicationLevel/">ApplicationLevel</a>
                    </li>
                    <li class="active">
                        <a href="./">LowLevelCode</a>
                    </li>
                    <li >
                        <a href="../WebSequenceDiagram/">WebSequenceDiagram</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ApplicationLevel/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../WebSequenceDiagram/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#low-level-cod">Low-level codе</a></li>
            <li><a href="#session25519-key1-key2">session25519 ( key1, key2 )</a></li>
            <li><a href="#gethash-string">getHash ( string )</a></li>
            <li><a href="#getrequesthash-requestbodyorurl">getRequestHash ( requestBodyOrUrl )</a></li>
            <li><a href="#encodebase58check-input">encodeBase58Check ( input )</a></li>
            <li><a href="#decodebase58check-input">decodeBase58Check ( input )</a></li>
            <li><a href="#hexstringtobyte-hexstring">hexStringToByte ( hexString )</a></li>
            <li><a href="#sign-data-privatekey">sign ( data, privateKey )</a></li>
            <li><a href="#newkeypair-passphrase">newKeyPair ( passPhrase )</a></li>
            <li><a href="#akpairtoraw-akpair">akPairToRaw ( akPair )</a></li>
            <li><a href="#encryptdata-secretorsharedkey-json-key">encryptData ( secretOrSharedKey, json, key )</a></li>
            <li><a href="#decryptdata-secretorsharedkey-messagewithnonce-key">decryptData ( secretOrSharedKey, messageWithNonce, key )</a></li>
            <li><a href="#encryptdatatopublickeywithkeypair-data-dstpublicenckey-srcakpair">encryptDataToPublicKeyWithKeyPair ( data, dstPublicEncKey, srcAkPair )</a></li>
            <li><a href="#decryptdatawithpublicandprivatekey-payload-srcpublicenckey-secretkey">decryptDataWithPublicAndPrivateKey ( payload, srcPublicEncKey, secretKey )</a></li>
            <li><a href="#encryptdatawithsymmetrickey-data-key">encryptDataWithSymmetricKey ( data, key )</a></li>
            <li><a href="#decryptdatawithsymmetrickey-messagewithnonce-key">decryptDataWithSymmetricKey ( messageWithNonce, key )</a></li>
            <li><a href="#encryptfiletopublickey-filedata-dstpublickey">encryptFileToPublicKey ( fileData, dstPublicKey )</a></li>
            <li><a href="#getfileuploaddata-fileobj-userchainid-userchainidpubkey">getFileUploadData ( fileObj, userChainId, userChainIdPubKey )</a></li>
            <li><a href="#processencryptedfileinfo-encryptedfileinfo-devicepublickey-browserprivatekey">processEncryptedFileInfo ( encryptedFileInfo, devicePublicKey, browserPrivateKey )</a></li>
            <li><a href="#getendpointurl-action-appendix">getEndpointUrl ( action, appendix )</a></li>
            <li><a href="#signmessage-message-secretkey">signMessage ( message, secretKey )</a></li>
            <li><a href="#verifymessage-message-signature-pubkey">verifyMessage ( message, signature, pubKey )</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="low-level-cod">Low-level codе</h1>
<h4 id="session25519-key1-key2">session25519 ( key1, key2 )</h4>
<p>Uses two strings, in our case six words per key, to create four keys for the user's key pair.</p>
<hr />
<h4 id="gethash-string">getHash ( string )</h4>
<p>Uses keccak256 (sha3) and returns the hash with the 0x prefix. </p>
<hr />
<h4 id="getrequesthash-requestbodyorurl">getRequestHash ( requestBodyOrUrl )</h4>
<p>In favor of better transaction validation, we decided to hash the content of every API call. This function is going to order the fields in JSON alphabetically and then hash it. This hash then will be added to the post request for back-end verification.  </p>
<hr />
<h4 id="encodebase58check-input">encodeBase58Check ( input )</h4>
<p>Encoding 32 byte[] into an address .</p>
<hr />
<h4 id="decodebase58check-input">decodeBase58Check ( input )</h4>
<p>Decoding into 32 byte[].</p>
<hr />
<h4 id="hexstringtobyte-hexstring">hexStringToByte ( hexString )</h4>
<p>A string representation of encrypted data into hex code is being converted into byte array. All hashes (keccak256/sha3) are such. </p>
<hr />
<h4 id="sign-data-privatekey">sign ( data, privateKey )</h4>
<p>Function to cryptogrphically sign, in our case a document, with user's private key.</p>
<hr />
<h4 id="newkeypair-passphrase">newKeyPair ( passPhrase )</h4>
<p>Generates key pair, account, for AEternity blockchain. Takes as parameter the passphrase, which the user receives as back-up words or generates new words with the <strong>diceware</strong> method. Then uses the session25519 function with 6 words per key.</p>
<pre><code>    key1 = words.slice(0, 6).join(' ');//0-5
    key2 = words.slice(6, 12).join(' ');//6-11

 else {
    key1 = diceware(6)
    key2 = diceware(6)
  }

  let phrase = `${key1} ${key2}`;
</code></pre>

<p>Then uses these keys to generate the user's key pair, containing four different keys with the full phrase.</p>
<pre><code> case&quot;ae&quot;:
    let publicSignBuffer = Buffer.from(keys.publicSignKey);
    secretSignBuffer = Buffer.from(keys.secretSignKey).toString('hex'); // 64-bytes private key
    let address = `ak_${encodeBase58Check(publicSignBuffer)}`;

    return {
        address: address,
        publicKey: address,
        secretKey: secretSignBuffer,
        publicEncKey: publicEncBufferEncoded,
        secretEncKey: secretEncBufferHex,
        phrase: phrase
    };

 case  &quot;eth&quot;:
    secretSignBuffer = Buffer.from(keys.secretKey); // 32-bytes private key
    let secretSignKey = `0x${secretSignBuffer.toString('hex')}`;
    let publicSignKey = ethCrypto.publicKeyByPrivateKey(secretSignKey);
    let publicAddress = ethCrypto.publicKey.toAddress(publicSignKey);

    return {
        address: publicAddress,
        publicKey: publicSignKey,
        secretKey: secretSignKey,
        publicEncKey: publicEncBufferEncoded,
        secretEncKey: secretEncBufferHex,
        phrase: phrase
    };
</code></pre>

<p><code>returns</code> <em>keyPair</em> object</p>
<hr />
<h4 id="akpairtoraw-akpair">akPairToRaw ( akPair )</h4>
<p>Converts and returns the Encryption key pair in raw bytes.</p>
<pre><code>return {
    secretEncKey: hexStringToByte(akPair.secretEncKey),
    publicEncKey: new Uint8Array(decodeBase58Check(akPair.publicEncKey))
}
</code></pre>

<hr />
<h4 id="encryptdata-secretorsharedkey-json-key">encryptData ( secretOrSharedKey, json, key )</h4>
<p>Takes as input secret or shared key, a JSON object and a key. Using asymmetric public key encryption. </p>
<p>Taken from <a href="https://github.com/dchest/tweetnacl-js/wiki/Examples">TweetNaCl Box example</a></p>
<p><code>returns</code> <em>Base64 encoded message</em></p>
<hr />
<h4 id="decryptdata-secretorsharedkey-messagewithnonce-key">decryptData ( secretOrSharedKey, messageWithNonce, key )</h4>
<p>Takes secret or shared key, encrypted message, and a key. Decrypts the message. </p>
<p>Taken from <a href="https://github.com/dchest/tweetnacl-js/wiki/Examples">TweetNaCl Box example</a></p>
<p><code>returns</code> <em>JSON.parse(Base64 decrypted message)</em> or when it comes from Java it shouldn't be parsed.  </p>
<hr />
<h4 id="encryptdatatopublickeywithkeypair-data-dstpublicenckey-srcakpair">encryptDataToPublicKeyWithKeyPair ( data, dstPublicEncKey, srcAkPair )</h4>
<p>Encrypts the data, and returns and object with the cyphered data. </p>
<pre><code>encrypted = {

    payload: encryptedData,
    dstPublicEncKey: dstPublicEncKey,
    srcPublicEncKey: srcAkPair.publicEncKey

  } 
</code></pre>

<hr />
<h4 id="decryptdatawithpublicandprivatekey-payload-srcpublicenckey-secretkey">decryptDataWithPublicAndPrivateKey ( payload, srcPublicEncKey, secretKey )</h4>
<p>Decrypts the data using TweetNacl box method and returns the decyphered data.</p>
<hr />
<h4 id="encryptdatawithsymmetrickey-data-key">encryptDataWithSymmetricKey ( data, key )</h4>
<p>Encrypts data with symmetric key using the TweetNaCl secret box methods. </p>
<p><code>returns</code> <em>Base64 encrypted message</em></p>
<hr />
<h4 id="decryptdatawithsymmetrickey-messagewithnonce-key">decryptDataWithSymmetricKey ( messageWithNonce, key )</h4>
<p>Decrypts the messageWithNonce with symmetric key using the TweetNacl secret box method. </p>
<p><code>returns</code> <em>UTF8 encoded decrypted message</em></p>
<hr />
<h4 id="encryptfiletopublickey-filedata-dstpublickey">encryptFileToPublicKey ( fileData, dstPublicKey )</h4>
<p>This function creates symmetric key. Encrypts with it and returns an object with the cyphered data and the information to recreate the sym key. Afterwards decrypt the message if you have the rest of the information.</p>
<hr />
<h4 id="getfileuploaddata-fileobj-userchainid-userchainidpubkey">getFileUploadData ( fileObj, userChainId, userChainIdPubKey )</h4>
<p>Encrypts the data with <strong>encryptFileToPublicKey</strong> method. Returns the following object</p>
<pre><code>let fileUploadData = {
        userId: userChainId,
        dataId: dataChainId,
        requestId: requestId,
        requestType: requestType,
        requestBodyHashSignature: 'NULL',
        trailHash: trailHash,
        trailHashSignatureHash: getHash(trailHash),
        dataName: fileObj.dataName,
        dataExtension: fileObj.dataExtension,
        category: fileObj.category,
        keywords: fileObj.keywords,
        payload: encryptedFile.payload,
        encryption: {
            dataOriginalHash: dataOriginalHash,
            salt: encryptedFile.credentials.salt,
            passHash: syncPassHash,
            encryptedPassA: encryptedFile.credentials.encryptedPass,
            pubKeyA: encryptedFile.credentials.encryptingPubKey
        }
    };
</code></pre>

<p>This object is then hashed with <strong>getRequestHash</strong>. After that the hash is being added to the object before the creation of post request. </p>
<pre><code>    fileUploadData.requestBodyHashSignature = getRequestHash(fileUploadData);

</code></pre>

<hr />
<h4 id="processencryptedfileinfo-encryptedfileinfo-devicepublickey-browserprivatekey">processEncryptedFileInfo ( encryptedFileInfo, devicePublicKey, browserPrivateKey )</h4>
<p>This function takes the file, gives it to the browser, the browser can now compose the full password and decrypt the file. </p>
<p><code>returns</code> <em>An object with decrypted message</em></p>
<hr />
<h4 id="getendpointurl-action-appendix">getEndpointUrl ( action, appendix )</h4>
<p>Gets the server route for the specific API call.</p>
<hr />
<h4 id="signmessage-message-secretkey">signMessage ( message, secretKey )</h4>
<p>This function is to encapsulate the different ways to sing a message depending on the network. At the moment it is to sign with either Eth or AE sign. </p>
<hr />
<h4 id="verifymessage-message-signature-pubkey">verifyMessage ( message, signature, pubKey )</h4></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
